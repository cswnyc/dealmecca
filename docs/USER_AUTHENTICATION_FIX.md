# User Authentication & Duplicate User Fix

## Problem Summary

Users were experiencing authentication issues where:
- Comments showed one username ("SolarWren")
- Profile showed a different username ("SharpHearts")

## Root Cause

**Duplicate user records with same Firebase UID**

Two users existed for the same Firebase authentication:
1. `SolarWren` (Pro user): Had `firebaseUid = null`, stored UID in `id` field instead
2. `SharpHearts`: Had correct `firebaseUid = dKTRYZzB6FTX8rxV9J8aXPzRqaI2`

When logging in:
- Profile lookup used `firebaseUid` field → Found SharpHearts
- Comment authorship used `id` field → Found SolarWren

**Additional Issues Found:**
- 3 total users had missing `firebaseUid` field
- All were created by seed scripts that didn't set `firebaseUid`

## Scripts That Created The Bug

1. `/scripts/create-admin-user.js` - Created users without `firebaseUid`
2. `/scripts/create-test-user.js` - Created users without `firebaseUid`
3. `/scripts/create-forum-users.ts` - Created users without `firebaseUid`

## Fix Applied

### 1. Merged Duplicate Users
- Migrated 8 comments from SharpHearts → SolarWren
- Deleted SharpHearts duplicate user
- Updated SolarWren with correct `firebaseUid`

### 2. Fixed All Users Missing firebaseUid
- CrystalChannels (cwonger@hotmail.com) - Fixed
- TechHopes (test@test.com) - Fixed
- SolarWren (pro@dealmecca.pro) - Fixed

### 3. Added Monitoring & Prevention

**Admin Dashboard Enhancement:**
- Added visual warning (⚠️) for users without `firebaseUid`
- Location: `/admin/users` page
- Shows red triangle icon next to username if `firebaseUid` is missing

**Utility Scripts Created:**
- `/scripts/check-duplicate-users.ts` - Checks for duplicate users and missing firebaseUid
- `/scripts/fix-duplicate-users.ts` - Merges duplicates and fixes missing firebaseUid
- `/scripts/ensure-all-users-have-firebase-uid.ts` - Validates all users have firebaseUid

## Prevention Guidelines

### For Future Seed Scripts

**❌ WRONG:**
```typescript
await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'User Name',
    role: 'ADMIN'
    // Missing firebaseUid!
  }
});
```

**✅ CORRECT:**
```typescript
import { randomBytes } from 'crypto';

// Generate a Firebase-compatible UID (28 characters)
const firebaseUid = randomBytes(14).toString('base64url');

await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'User Name',
    firebaseUid: firebaseUid, // ✓ Always include this!
    role: 'ADMIN'
  }
});
```

### For Production API Routes

The core authentication system (`/server/authUser.ts`) is correct and already includes `firebaseUid`. Always use:

```typescript
import { ensureDbUserFromFirebase } from '@/server/authUser';

// This function properly sets firebaseUid
const user = await ensureDbUserFromFirebase(decoded);
```

## Verification

Run these commands to verify no issues:

```bash
# Check for users without firebaseUid
npx tsx scripts/check-duplicate-users.ts

# If issues found, fix them
npx tsx scripts/ensure-all-users-have-firebase-uid.ts

# View in admin dashboard
# Go to: http://localhost:3002/admin/users
# Look for ⚠️ warning icons
```

## Database Schema

```typescript
model User {
  id: string @id @default(cuid())
  firebaseUid: string? @unique // ← THIS MUST ALWAYS BE SET!
  email: string? @unique
  name: string?
  // ... other fields
}
```

**Key Points:**
- `firebaseUid` must be unique across all users
- It's used to look up users during authentication
- Without it, users cannot log in properly
- The `id` field is auto-generated by Prisma (CUID format)
- The `firebaseUid` must be explicitly set when creating users

## Test Accounts

All test accounts now have correct `firebaseUid`:

- **Admin**: admin@dealmecca.pro / password123
- **Pro**: pro@dealmecca.pro / test123
- **Test**: test@test.com / password123

## Final Status

✅ All users now have `firebaseUid`
✅ No duplicate users exist
✅ Admin dashboard shows warnings for future issues
✅ Utility scripts available for monitoring
✅ Prevention guidelines documented

---

*Fixed on: 2025-10-12*
*Issue: Username inconsistency between comments and profile*
*Users affected: 3 (all test/seed accounts)*
