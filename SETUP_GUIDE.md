# ðŸŽ¯ Complete Payment Flow Setup & Testing Guide

## Step 1: Update Your .env File

Replace the placeholder values in your `.env` file with real Stripe test keys:

```bash
# Database
DATABASE_URL="postgresql://username:password@localhost:5432/dealmecca?schema=public"

# NextAuth.js
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-actual-nextauth-secret-here"  # Generate: openssl rand -base64 32

# Stripe Configuration (Replace with your actual test keys)
STRIPE_SECRET_KEY="sk_test_your_actual_secret_key_here"
STRIPE_PUBLISHABLE_KEY="pk_test_your_actual_publishable_key_here"
STRIPE_WEBHOOK_SECRET="whsec_your_webhook_secret_from_stripe_cli"

# Stripe Price IDs (Will be generated by setup script)
STRIPE_PRO_MONTHLY_PRICE_ID="price_your_generated_price_id"
STRIPE_PRO_ANNUAL_PRICE_ID="price_your_generated_price_id"
STRIPE_TEAM_MONTHLY_PRICE_ID="price_your_generated_price_id"
STRIPE_TEAM_ANNUAL_PRICE_ID="price_your_generated_price_id"
```

## Step 2: Install & Set Up Stripe CLI

Since webhooks need to be publicly accessible, we'll use Stripe CLI to forward webhooks to your local development server.

### Install Stripe CLI:

**macOS (using Homebrew):**
```bash
brew install stripe/stripe-cli/stripe
```

**Other platforms:** Download from [https://github.com/stripe/stripe-cli/releases](https://github.com/stripe/stripe-cli/releases)

### Login to Stripe CLI:
```bash
stripe login
```

### Forward webhooks to your local server:
```bash
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

This command will:
- Start listening for webhook events from your Stripe account
- Forward them to your local `http://localhost:3000/api/stripe/webhook`
- Display a webhook signing secret like `whsec_1A2B3C...`

**Important:** Copy the webhook signing secret from the CLI output and add it to your `.env` file as `STRIPE_WEBHOOK_SECRET`.

## Step 3: Create Products and Prices

Run the setup script to create products and prices in your Stripe account:

```bash
# Replace with your actual Stripe secret key
STRIPE_SECRET_KEY=sk_test_your_actual_key_here node setup-stripe-products.js
```

This will create all products and display the price IDs. Copy these into your `.env` file.

## Step 4: Test the Complete Payment Flow

### Start your development servers:

**Terminal 1 - Next.js app:**
```bash
npm run dev
```

**Terminal 2 - Stripe webhook forwarding:**
```bash
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

**Terminal 3 - Prisma Studio (optional):**
```bash
npx prisma studio --port 5557
```

### Test the flow:

1. **Visit the pricing page:** http://localhost:3000/pricing
2. **Click "Get Started" on Pro or Team plan**
3. **You should be redirected to Stripe Checkout**
4. **Use test card:** `4242 4242 4242 4242` with any future expiry and CVC
5. **Complete the payment**
6. **Check webhook events in your Stripe CLI terminal**
7. **Verify the success page loads**

## Step 5: Verify Database Updates

Check Prisma Studio (http://localhost:5557) to see:
- User's subscription status updated
- Payment record created
- Stripe customer ID linked

## Step 6: Test with Different User Accounts

Test with the existing accounts:
- `free@dealmecca.pro` (should show upgrade prompts)
- `pro@dealmecca.pro` (should show Pro features enabled)
- `admin@dealmecca.pro` (admin access)

Password for all: `password123`

## Troubleshooting

### Common Issues:

1. **Webhook signature verification failed:**
   - Make sure `STRIPE_WEBHOOK_SECRET` matches the value from `stripe listen`
   - Restart your Next.js server after updating `.env`

2. **Stripe CLI not forwarding:**
   - Check that Stripe CLI is logged in: `stripe login`
   - Ensure the forward URL is correct: `localhost:3000/api/stripe/webhook`

3. **Products not creating:**
   - Verify your `STRIPE_SECRET_KEY` is correct
   - Make sure you're in Test Mode in Stripe Dashboard

### Test Commands:

```bash
# Test payment flow endpoints
node test-payment-flow.js

# Test webhook manually
curl -X POST http://localhost:3000/api/stripe/webhook \
  -H "stripe-signature: test-signature" \
  -d '{"type":"test"}'
```

## Next Steps

Once local testing works:
1. Deploy to a staging environment (Vercel, Railway, etc.)
2. Add the staging webhook URL to Stripe Dashboard
3. Test with real payment flows
4. Deploy to production

## Quick Reference

- **Stripe Dashboard:** https://dashboard.stripe.com/test
- **Stripe CLI Docs:** https://stripe.com/docs/stripe-cli
- **Test Cards:** https://stripe.com/docs/testing#cards
- **Local App:** http://localhost:3000
- **Prisma Studio:** http://localhost:5557 